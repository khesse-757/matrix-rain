<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Matrix Rain</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
            touch-action: none;
            -webkit-touch-callout: none;
        }
        
        #canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: pointer;
            touch-action: none;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border: 1px solid #0f0;
            border-radius: 5px;
            z-index: 10;
            touch-action: auto;
        }
        
        .controls button {
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
            touch-action: auto;
        }
        
        .controls button:hover {
            background: #0f0;
            color: #000;
        }
        
        .speed-control {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #0f0;
        }
        
        .speed-control label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .speed-buttons {
            display: flex;
            gap: 5px;
        }
        
        .speed-buttons button {
            flex: 1;
            padding: 5px;
            font-size: 11px;
        }
        
        .speed-buttons button.active {
            background: #0f0;
            color: #000;
        }
        
        .toggle-control {
            margin-top: 10px;
        }
        
        .toggle-control button {
            width: 100%;
        }
        
        .info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border: 1px solid #0f0;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .info a {
            color: #0f0;
            text-decoration: none;
        }
        
        .info a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div class="controls">
        <button id="pauseBtn">Pause</button>
        <button id="resetBtn">Reset</button>
        
        <div class="speed-control">
            <label>Speed:</label>
            <div class="speed-buttons">
                <button id="slowBtn">Slow</button>
                <button id="normalBtn" class="active">Normal</button>
                <button id="fastBtn">Fast</button>
            </div>
        </div>
        
        <div class="toggle-control">
            <button id="randomBtn">Random Speeds: Off</button>
        </div>
    </div>
    
    <div class="info">
        <div>Matrix Rain Visualizer</div>
        <div><a href="https://github.com/khesse-757/matrix-rain" target="_blank">View Source</a></div>
    </div>

    <script type="py" src="./matrix.py" config="./pyscript.toml"></script>
    <script type="py">
        import js
        from pyodide.ffi import create_proxy
        import random
        import string
        import math
        
        canvas = js.document.getElementById("canvas")
        ctx = canvas.getContext("2d")
        
        # Set canvas size
        canvas.width = js.window.innerWidth
        canvas.height = js.window.innerHeight
        
        # Matrix rain settings
        font_size = 16
        columns = canvas.width // font_size
        drops = [0] * columns
        drop_speeds = [1.0] * columns  # Individual speed for each column
        characters = string.ascii_letters + string.digits + "!@#$%^&*()"
        
        # Animation state
        paused = False
        speed = 1.0  # Speed multiplier: 0.3 = slow, 1.0 = normal, 1.8 = fast
        random_speeds = False  # Whether to use random individual speeds
        
        # Mouse/touch interaction
        mouse_x = -1000
        mouse_y = -1000
        repel_radius = 100
        
        def initialize_random_speeds():
            """Set random speeds for each column."""
            global drop_speeds
            drop_speeds = [random.uniform(0.3, 2.0) for _ in range(columns)]
        
        def initialize_uniform_speeds():
            """Set uniform speeds for all columns."""
            global drop_speeds
            drop_speeds = [1.0] * columns
        
        def draw():
            # Semi-transparent black for trail effect
            ctx.fillStyle = "rgba(0, 0, 0, 0.05)"
            ctx.fillRect(0, 0, canvas.width, canvas.height)
            
            ctx.fillStyle = "#0f0"
            ctx.font = f"{font_size}px monospace"
            
            for i in range(len(drops)):
                # Random character
                char = random.choice(characters)
                x = i * font_size
                y = drops[i] * font_size
                
                # Only draw if drop is visible (not above screen)
                if y > 0:
                    # Calculate distance from mouse
                    dx = x - mouse_x
                    dy = y - mouse_y
                    distance = math.sqrt(dx * dx + dy * dy)
                    
                    # Repel effect
                    if distance < repel_radius:
                        # Push drop away from mouse
                        angle = math.atan2(dy, dx)
                        push_force = (repel_radius - distance) / repel_radius
                        offset_x = math.cos(angle) * push_force * 30
                        x += offset_x
                    
                    ctx.fillText(char, x, y)
                
                # Reset drop to top randomly
                if y > canvas.height and random.random() > 0.975:
                    drops[i] = 0
                
                # Apply speed multiplier and individual column speed
                drops[i] += speed * drop_speeds[i]
        
        def animate(timestamp):
            if not paused:
                draw()
            js.window.requestAnimationFrame(create_proxy(animate))
        
        def toggle_pause(event):
            global paused
            paused = not paused
            btn = js.document.getElementById("pauseBtn")
            btn.textContent = "Resume" if paused else "Pause"
        
        def reset(event):
            global drops
            drops = [0] * columns
            
            # Completely clear the screen with solid black to remove old trails
            ctx.fillStyle = "#000"
            ctx.fillRect(0, 0, canvas.width, canvas.height)
            
            # Force a single draw call to show the new state immediately
            draw()
        
        def set_speed(new_speed, button_id):
            global speed
            speed = new_speed
            
            # Update button styles
            for btn_id in ["slowBtn", "normalBtn", "fastBtn"]:
                btn = js.document.getElementById(btn_id)
                if btn_id == button_id:
                    btn.classList.add("active")
                else:
                    btn.classList.remove("active")
        
        def set_slow(event):
            set_speed(0.3, "slowBtn")
        
        def set_normal(event):
            set_speed(1.0, "normalBtn")
        
        def set_fast(event):
            set_speed(1.8, "fastBtn")
        
        def toggle_random_speeds(event):
            global random_speeds
            random_speeds = not random_speeds
            
            btn = js.document.getElementById("randomBtn")
            if random_speeds:
                btn.textContent = "Random Speeds: On"
                btn.classList.add("active")
                initialize_random_speeds()
            else:
                btn.textContent = "Random Speeds: Off"
                btn.classList.remove("active")
                initialize_uniform_speeds()
        
        def resize(event):
            global columns, drops, drop_speeds
            canvas.width = js.window.innerWidth
            canvas.height = js.window.innerHeight
            columns = canvas.width // font_size
            drops = [0] * columns
            
            # Reinitialize speeds based on current mode
            if random_speeds:
                initialize_random_speeds()
            else:
                initialize_uniform_speeds()
        
        def update_mouse_position(x, y):
            global mouse_x, mouse_y
            mouse_x = x
            mouse_y = y
        
        def mouse_move(event):
            update_mouse_position(event.clientX, event.clientY)
        
        def handle_touch(event):
            # Only handle touches on the canvas, not on controls
            target = event.target
            if target.id == "canvas":
                event.preventDefault()
                if event.touches.length > 0:
                    touch = event.touches[0]
                    update_mouse_position(touch.clientX, touch.clientY)
        
        def mouse_leave(event):
            global mouse_x, mouse_y
            mouse_x = -1000
            mouse_y = -1000
        
        def touch_end(event):
            # Only clear if no more touches
            if event.touches.length == 0:
                mouse_leave(event)
        
        # Event listeners
        js.document.getElementById("pauseBtn").addEventListener("click", create_proxy(toggle_pause))
        js.document.getElementById("resetBtn").addEventListener("click", create_proxy(reset))
        js.document.getElementById("slowBtn").addEventListener("click", create_proxy(set_slow))
        js.document.getElementById("normalBtn").addEventListener("click", create_proxy(set_normal))
        js.document.getElementById("fastBtn").addEventListener("click", create_proxy(set_fast))
        js.document.getElementById("randomBtn").addEventListener("click", create_proxy(toggle_random_speeds))
        js.window.addEventListener("resize", create_proxy(resize))
        canvas.addEventListener("mousemove", create_proxy(mouse_move))
        canvas.addEventListener("mouseleave", create_proxy(mouse_leave))
        js.document.addEventListener("touchstart", create_proxy(handle_touch), {"passive": False})
        js.document.addEventListener("touchmove", create_proxy(handle_touch), {"passive": False})
        js.document.addEventListener("touchend", create_proxy(touch_end), {"passive": False})
        
        # Start animation
        js.window.requestAnimationFrame(create_proxy(animate))
    </script>
</body>
</html>